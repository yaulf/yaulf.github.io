import React, { useState, useEffect, useCallback } from 'react';
import { 
  Keyboard, 
  Monitor, 
  Mouse, 
  Printer, 
  Mic, 
  Speaker, 
  Camera, 
  Headset,
  ScanBarcode,
  Tablet,
  ArrowLeftRight,
  CheckCircle, 
  XCircle, 
  HelpCircle,
  Trophy,
  RefreshCw,
  ArrowRight
} from 'lucide-react';

/* ---------- Data ---------- */
const DEVICES = [
  { id: 'keyboard', name: 'Keyboard', type: 'Input', icon: <Keyboard size={120} strokeWidth={1} />, description: "Allows you to type letters, numbers, and commands into the computer.", question: "What is the primary function of this device?", options: ["To display video games","To enter alphanumeric data","To print documents on paper","To record high-quality sound"], correctOption: 1 },
  { id: 'monitor', name: 'Monitor', type: 'Output', icon: <Monitor size={120} strokeWidth={1} />, description: "Displays the visual output from the computer's graphics card.", question: "Which statement best describes this device?", options: ["It processes data like a brain","It captures images from the room","It displays visual information to the user","It stores all your files permanently"], correctOption: 2 },
  { id: 'mouse', name: 'Mouse', type: 'Input', icon: <Mouse size={120} strokeWidth={1} />, description: "A hand-held pointing device that detects two-dimensional motion relative to a surface.", question: "What is this device mainly used for?", options: ["Typing long essays","Controlling the on-screen cursor","Scanning physical photos","Cooling down the CPU"], correctOption: 1 },
  { id: 'printer', name: 'Printer', type: 'Output', icon: <Printer size={120} strokeWidth={1} />, description: "Produces a hard copy (permanent human-readable text and/or graphics) of documents.", question: "What is the output of this device?", options: ["Digital video files","Physical paper documents","Audio waves","3D Holograms"], correctOption: 1 },
  { id: 'mic', name: 'Microphone', type: 'Input', icon: <Mic size={120} strokeWidth={1} />, description: "Converts sound into an electrical signal.", question: "How does this device interact with the computer?", options: ["It captures audio from the environment","It projects sound into the room","It takes photos of the user","It allows you to listen to music"], correctOption: 0 },
  { id: 'speaker', name: 'Speakers', type: 'Output', icon: <Speaker size={120} strokeWidth={1} />, description: "Converts electrical audio signals into corresponding sound.", question: "What is the primary purpose of this device?", options: ["To record your voice","To cool the computer system","To produce audible sound","To boost internet speed"], correctOption: 2 },
  { id: 'webcam', name: 'Webcam', type: 'Input', icon: <Camera size={120} strokeWidth={1} />, description: "A video camera that feeds or streams an image or video in real time.", question: "What is this device used for during a meeting?", options: ["Hearing what others say","Typing messages in chat","Transmitting your video feed","Printing meeting notes"], correctOption: 2 },
  { id: 'headset', name: 'Headset', type: 'Both', icon: <Headset size={120} strokeWidth={1} />, description: "Combines headphones with a microphone. Used for two-way communication like calls or gaming.", question: "Why is a Headset classified as 'Both'?", options: ["It blocks outside noise","It allows you to hear (Output) and speak (Input)","It connects via Bluetooth","It is smaller than speakers"], correctOption: 1 },
  { id: 'touchscreen', name: 'Touchscreen', type: 'Both', icon: <Tablet size={120} strokeWidth={1} />, description: "An electronic visual display that the user can control through simple or multi-touch gestures.", question: "Why is a touchscreen considered both Input and Output?", options: ["It has a keyboard attached","It displays visual info AND accepts touch commands","It is wireless","It can print paper while you type"], correctOption: 1 },
  { id: 'barcode', name: 'Barcode Reader', type: 'Input', icon: <ScanBarcode size={120} strokeWidth={1} />, description: "An optical scanner that reads printed barcodes, decodes the data, and sends it to a computer.", question: "What is the primary use of this device?", options: ["To print receipts","To scan and input product codes","To display prices on a screen","To generate QR codes"], correctOption: 1 }
];

/* ---------- Small UI components ---------- */
const Card = ({ children, isSelected, isMatched, onClick, className = "" }) => {
  return (
    <button
      type="button"
      onClick={!isMatched ? onClick : undefined}
      aria-pressed={isSelected}
      disabled={isMatched}
      className={`
        relative flex items-center justify-center p-4 rounded-xl border-2 transition-all duration-300 overflow-hidden text-left
        ${isMatched ? 'bg-white/60 border-green-400 opacity-60 cursor-default' : isSelected ? 'bg-blue-50 border-blue-400 scale-105 shadow-lg ring-2 ring-blue-200' : 'bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm'}
        ${className}
      `}
    >
      {isMatched && (
        <span className="absolute top-3 right-3 text-green-600" aria-hidden>
          <CheckCircle size={20} />
        </span>
      )}
      {children}
    </button>
  );
};

const Modal = ({ isOpen, title, children, onClose }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        <div className="flex items-center justify-between bg-blue-600 text-white p-4">
          <div className="flex items-center gap-2 font-bold text-lg">
            <HelpCircle />
            <span>{title}</span>
          </div>
          <button className="text-white/90" onClick={onClose} aria-label="Close dialog">✕</button>
        </div>
        <div className="p-6">{children}</div>
      </div>
    </div>
  );
};

/* ---------- Main App ---------- */
export default function App() {
  const [shuffledDevices, setShuffledDevices] = useState([]);
  const [shuffledNames, setShuffledNames] = useState([]);
  const [selectedDevice, setSelectedDevice] = useState(null);
  const [selectedName, setSelectedName] = useState(null);
  const [matchedIds, setMatchedIds] = useState(new Set());
  const [score, setScore] = useState(0);
  const [quizState, setQuizState] = useState({ isOpen: false, stage: 'classify', device: null, feedback: null });
  const [gameComplete, setGameComplete] = useState(false);

  // init
  const initGame = useCallback(() => {
    const devicesCopy = [...DEVICES].sort(() => Math.random() - 0.5);
    const namesCopy = [...DEVICES].map(d => ({ id: d.id, name: d.name })).sort(() => Math.random() - 0.5);
    setShuffledDevices(devicesCopy);
    setShuffledNames(namesCopy);
    setMatchedIds(new Set());
    setScore(0);
    setSelectedDevice(null);
    setSelectedName(null);
    setQuizState({ isOpen: false, stage: 'classify', device: null, feedback: null });
    setGameComplete(false);
  }, []);

  useEffect(() => { initGame(); }, [initGame]);

  useEffect(() => {
    if (matchedIds.size > 0 && matchedIds.size === DEVICES.length) {
      setGameComplete(true);
    }
  }, [matchedIds]);

  const selectDevice = (device) => {
    if (matchedIds.has(device.id)) return;
    const newSelection = selectedDevice === device.id ? null : device.id;
    setSelectedDevice(newSelection);
    // attempt match if name already selected
    if (selectedName) {
      attemptMatch(newSelection, selectedName);
    }
  };

  const selectName = (nameItem) => {
    if (matchedIds.has(nameItem.id)) return;
    const newSelection = selectedName === nameItem.id ? null : nameItem.id;
    setSelectedName(newSelection);
    if (selectedDevice) {
      attemptMatch(selectedDevice, newSelection);
    }
  };

  const attemptMatch = (devId, nameId) => {
    if (!devId || !nameId) return;
    if (devId === nameId) {
      // open modal for classify stage
      const device = DEVICES.find(d => d.id === devId);
      // award small immediate points for identifying a correct pair click
      setScore(s => s + 10);
      // show modal
      setTimeout(() => {
        setQuizState({ isOpen: true, stage: 'classify', device, feedback: null });
      }, 250);
    } else {
      // shake feedback: deselect both after delay
      setTimeout(() => {
        setSelectedDevice(null);
        setSelectedName(null);
      }, 500);
    }
  };

  const handleClassify = (choice) => {
    const device = quizState.device;
    if (!device) return;
    const correct = device.type === choice;
    if (correct) {
      setScore(s => s + 15);
      setQuizState(prev => ({ ...prev, stage: 'function', feedback: { type: 'success', msg: 'Correct classification!' } }));
    } else {
      setScore(s => Math.max(0, s - 5));
      setQuizState(prev => ({ ...prev, feedback: { type: 'error', msg: 'Incorrect — try again.' } }));
      setTimeout(() => setQuizState(prev => ({ ...prev, feedback: null })), 1400);
    }
  };

  const handleFunctionAnswer = (idx) => {
    const device = quizState.device;
    if (!device) return;
    const correct = idx === device.correctOption;
    if (correct) {
      setScore(s => s + 25);
      // lock in matched pair
      setMatchedIds(prev => new Set(prev).add(device.id));
      // clear selections, close modal
      setSelectedDevice(null);
      setSelectedName(null);
      setQuizState({ isOpen: false, stage: 'classify', device: null, feedback: null });
    } else {
      setScore(s => Math.max(0, s - 5));
      setQuizState(prev => ({ ...prev, feedback: { type: 'error', msg: 'Incorrect function answer.' } }));
      setTimeout(() => setQuizState(prev => ({ ...prev, feedback: null })), 1400);
    }
  };

  const closeModal = () => {
    setQuizState({ isOpen: false, stage: 'classify', device: null, feedback: null });
    setSelectedDevice(null);
    setSelectedName(null);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      <header className="bg-white shadow sticky top-0 z-20">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 p-2 rounded-lg text-white"><Monitor /></div>
            <div>
              <h1 className="text-lg font-bold">Valtorta College Input Output Master</h1>
              <p className="text-xs text-slate-500">Tech Education Game</p>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="hidden sm:block text-sm text-slate-500 text-right">
              <div className="uppercase font-bold tracking-wide">Progress</div>
              <div className="font-bold text-slate-700">{matchedIds.size} / {DEVICES.length} Pairs</div>
            </div>
            <div className="bg-slate-900 text-white px-4 py-2 rounded-full font-mono font-bold text-lg flex items-center gap-2">
              <Trophy size={16} className="text-yellow-400" />
              {score}
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-8">
        {gameComplete ? (
          <div className="bg-white rounded-3xl shadow-xl p-12 text-center">
            <div className="w-24 h-24 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center mx-auto mb-6">
              <Trophy size={48} />
            </div>
            <h2 className="text-3xl font-extrabold text-slate-900 mb-3">Excellent Work!</h2>
            <p className="text-slate-600 mb-6 max-w-md mx-auto">You matched all devices and identified their functions correctly. You're a hardware expert!</p>
            <div className="text-5xl font-bold text-blue-600 mb-6">{score} <span className="text-2xl text-slate-400">pts</span></div>
            <button onClick={initGame} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold inline-flex items-center gap-2">
              <RefreshCw />
              Play Again
            </button>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            {/* Left: Devices */}
            <section>
              <h3 className="text-sm font-semibold text-slate-500 uppercase mb-4 flex items-center gap-2">
                <Camera size={14} />
                Device Photos
              </h3>
              <div className="grid grid-cols-2 gap-4">
                {shuffledDevices.map(device => (
                  <Card key={device.id} isSelected={selectedDevice === device.id} isMatched={matchedIds.has(device.id)} onClick={() => selectDevice(device)} className="h-44">
                    <div className={`transition-transform ${matchedIds.has(device.id) ? 'opacity-60' : 'hover:scale-105'}`}>
                      {React.cloneElement(device.icon, { size: 92 })}
                    </div>
                  </Card>
                ))}
              </div>
            </section>

            {/* Right: Names */}
            <section>
              <h3 className="text-sm font-semibold text-slate-500 uppercase mb-4 flex items-center gap-2 justify-end">
                <Keyboard size={14} />
                <span>Device Names</span>
              </h3>
              <div className="space-y-3">
                {shuffledNames.map(item => (
                  <Card key={item.id} isSelected={selectedName === item.id} isMatched={matchedIds.has(item.id)} onClick={() => selectName(item)} className="h-16 flex items-center justify-between px-6">
                    <span className={`font-bold text-lg ${matchedIds.has(item.id) ? 'line-through text-slate-400' : 'text-slate-700'}`}>{item.name}</span>
                    {matchedIds.has(item.id) ? <CheckCircle size={18} className="text-green-500" /> : <span className="w-4 h-4 rounded-full border-2 border-slate-200" />}
                  </Card>
                ))}
              </div>
            </section>
          </div>
        )}
      </main>

      <Modal isOpen={quizState.isOpen} title={quizState.stage === 'classify' ? 'Classify Device' : 'Identify Function'} onClose={closeModal}>
        {quizState.device && (
          <div>
            <div className="flex items-center gap-4 border-b pb-4 mb-4">
              <div className="bg-blue-50 p-2 rounded">{React.cloneElement(quizState.device.icon, { size: 44 })}</div>
              <div>
                <div className="font-bold text-lg">{quizState.device.name}</div>
                <div className="text-sm text-slate-500">Identify this component</div>
              </div>
            </div>

            {quizState.feedback && (
              <div className={`p-3 rounded mb-4 text-sm font-semibold ${quizState.feedback.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                {quizState.feedback.msg}
              </div>
            )}

            {quizState.stage === 'classify' && (
              <>
                <p className="mb-4 text-slate-700">Is this an Input, Output, or Both?</p>
                <div className="grid grid-cols-3 gap-3">
                  <button onClick={() => handleClassify('Input')} className="p-3 rounded border hover:bg-blue-50">Input</button>
                  <button onClick={() => handleClassify('Output')} className="p-3 rounded border hover:bg-purple-50">Output</button>
                  <button onClick={() => handleClassify('Both')} className="p-3 rounded border hover:bg-orange-50">Both</button>
                </div>
              </>
            )}

            {quizState.stage === 'function' && (
              <>
                <p className="mb-4 text-slate-700">{quizState.device.question}</p>
                <div className="space-y-3">
                  {quizState.device.options.map((opt, idx) => (
                    <button key={idx} onClick={() => handleFunctionAnswer(idx)} className="w-full p-3 text-left rounded border hover:bg-blue-50 flex items-center justify-between">
                      <span>{opt}</span>
                      <span className="w-4 h-4 rounded-full border-2 border-slate-200" />
                    </button>
                  ))}
                </div>
              </>
            )}
          </div>
        )}
      </Modal>
    </div>
  );
}